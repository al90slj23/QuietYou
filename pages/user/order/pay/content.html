<div class="order-pay-page" id="orderPayPage">
  <!-- è®¢å•ä¿¡æ¯ -->
  <div class="section card">
    <div class="order-info">
      <div class="order-no">
        <span class="label">è®¢å•ç¼–å·</span>
        <span class="value" id="orderNo">QY20260111143000ABCD</span>
      </div>
      <div class="order-service">
        <div class="service-icon" id="serviceIcon">ğŸ’†</div>
        <div class="service-detail">
          <div class="service-name" id="serviceName">å…¨èº«ä¸­å¼æ¨æ‹¿</div>
          <div class="service-tech">æŠ€å¸ˆï¼š<span id="techName">å¼ å¸ˆå‚…</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ”¯ä»˜é‡‘é¢ -->
  <div class="section card">
    <div class="pay-amount">
      <span class="label">æ”¯ä»˜é‡‘é¢</span>
      <span class="amount" id="payAmount">Â¥298.00</span>
    </div>
  </div>

  <!-- æ”¯ä»˜æ–¹å¼ -->
  <div class="section card">
    <div class="section-title">é€‰æ‹©æ”¯ä»˜æ–¹å¼</div>
    <div class="pay-methods">
      <label class="pay-method active" data-method="wechat">
        <input type="radio" name="payMethod" value="wechat" checked>
        <span class="method-icon">ğŸ’š</span>
        <span class="method-name">å¾®ä¿¡æ”¯ä»˜</span>
        <span class="method-check">âœ“</span>
      </label>
      <label class="pay-method" data-method="alipay">
        <input type="radio" name="payMethod" value="alipay">
        <span class="method-icon">ğŸ’™</span>
        <span class="method-name">æ”¯ä»˜å®</span>
        <span class="method-check">âœ“</span>
      </label>
      <label class="pay-method" data-method="balance">
        <input type="radio" name="payMethod" value="balance">
        <span class="method-icon">ğŸ’°</span>
        <span class="method-name">ä½™é¢æ”¯ä»˜</span>
        <span class="method-sub">å¯ç”¨ä½™é¢ Â¥0.00</span>
        <span class="method-check">âœ“</span>
      </label>
    </div>
  </div>

  <!-- æ”¯ä»˜å€’è®¡æ—¶ -->
  <div class="section countdown-section">
    <span class="countdown-text">è¯·åœ¨ <span id="countdown">15:00</span> å†…å®Œæˆæ”¯ä»˜</span>
    <span class="countdown-tip">è¶…æ—¶è®¢å•å°†è‡ªåŠ¨å–æ¶ˆ</span>
  </div>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <div class="bottom-bar">
    <button class="btn btn-secondary btn-cancel" onclick="cancelOrder()">å–æ¶ˆè®¢å•</button>
    <button class="btn btn-primary btn-pay" onclick="confirmPay()">ç¡®è®¤æ”¯ä»˜ Â¥<span id="payBtn">298.00</span></button>
  </div>
</div>

<!-- æ”¯ä»˜ç»“æœå¼¹çª— -->
<div class="pay-result-modal" id="payResultModal" style="display: none;">
  <div class="modal-content">
    <div class="result-icon" id="resultIcon">âœ…</div>
    <div class="result-title" id="resultTitle">æ”¯ä»˜æˆåŠŸ</div>
    <div class="result-desc" id="resultDesc">è®¢å•å·²æäº¤ï¼Œç­‰å¾…æŠ€å¸ˆæ¥å•</div>
    <div class="result-actions">
      <button class="btn btn-primary btn-block" onclick="viewOrder()">æŸ¥çœ‹è®¢å•</button>
      <button class="btn btn-secondary btn-block" onclick="backToHome()">è¿”å›é¦–é¡µ</button>
    </div>
  </div>
</div>

<style>
.order-pay-page {
  background: var(--bg-color);
  min-height: 100%;
  padding-bottom: 80px;
}

.section {
  margin: 12px;
}

.section-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 16px;
}

/* Order Info */
.order-info {
  padding: 4px 0;
}

.order-no {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border-color);
  margin-bottom: 12px;
}

.order-no .label {
  font-size: 13px;
  color: var(--text-placeholder);
}

.order-no .value {
  font-size: 13px;
  color: var(--text-secondary);
  font-family: monospace;
}

.order-service {
  display: flex;
  align-items: center;
}

.service-icon {
  width: 48px;
  height: 48px;
  border-radius: 8px;
  background: var(--primary-light);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  margin-right: 12px;
}

.service-detail {
  flex: 1;
}

.service-name {
  font-size: 15px;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.service-tech {
  font-size: 13px;
  color: var(--text-secondary);
}

/* Pay Amount */
.pay-amount {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
}

.pay-amount .label {
  font-size: 15px;
  color: var(--text-primary);
}

.pay-amount .amount {
  font-size: 28px;
  font-weight: 600;
  color: var(--danger-color);
}

/* Pay Methods */
.pay-methods {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.pay-method {
  display: flex;
  align-items: center;
  padding: 14px 12px;
  background: var(--bg-color);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
}

.pay-method.active {
  background: var(--primary-light);
  border-color: var(--primary-color);
}

.pay-method input {
  display: none;
}

.method-icon {
  font-size: 24px;
  margin-right: 12px;
}

.method-name {
  flex: 1;
  font-size: 15px;
  color: var(--text-primary);
}

.method-sub {
  font-size: 12px;
  color: var(--text-placeholder);
  margin-left: 8px;
}

.method-check {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--border-color);
  color: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  transition: all 0.2s;
}

.pay-method.active .method-check {
  background: var(--primary-color);
  color: #fff;
}

/* Countdown */
.countdown-section {
  text-align: center;
  padding: 16px;
}

.countdown-text {
  font-size: 14px;
  color: var(--text-secondary);
}

.countdown-text #countdown {
  color: var(--danger-color);
  font-weight: 600;
  font-family: monospace;
}

.countdown-tip {
  display: block;
  font-size: 12px;
  color: var(--text-placeholder);
  margin-top: 4px;
}

/* Bottom Bar */
.bottom-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 70px;
  background: var(--bg-white);
  border-top: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  padding: 0 16px;
  gap: 12px;
  z-index: 100;
}

.btn-cancel {
  padding: 12px 20px;
  font-size: 15px;
  border-radius: 24px;
}

.btn-pay {
  flex: 1;
  padding: 12px 20px;
  font-size: 16px;
  border-radius: 24px;
}

/* Pay Result Modal */
.pay-result-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  width: 80%;
  max-width: 320px;
  background: var(--bg-white);
  border-radius: 12px;
  padding: 32px 24px;
  text-align: center;
}

.result-icon {
  font-size: 64px;
  margin-bottom: 16px;
}

.result-icon.success {
  color: var(--primary-color);
}

.result-icon.fail {
  color: var(--danger-color);
}

.result-title {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.result-desc {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 24px;
}

.result-actions {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.result-actions .btn {
  padding: 12px;
  font-size: 15px;
  border-radius: 8px;
}

/* Loading */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.loading-content {
  background: var(--bg-white);
  padding: 24px 32px;
  border-radius: 8px;
  text-align: center;
}

.loading-spinner {
  font-size: 32px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.loading-text {
  margin-top: 12px;
  font-size: 14px;
  color: var(--text-secondary);
}
</style>


<script>
(function() {
  // ä» sessionStorage è·å–è®¢å•æ•°æ®
  const orderDataStr = sessionStorage.getItem('currentOrder');
  
  if (!orderDataStr) {
    QY.showToast('è®¢å•æ•°æ®ä¸å­˜åœ¨');
    setTimeout(() => QY.navigateTo('home'), 1500);
    return;
  }

  const orderData = JSON.parse(orderDataStr);
  
  // æ”¯ä»˜çŠ¶æ€
  let paymentStatus = 'pending'; // pending, processing, success, failed
  let countdownTimer = null;
  let remainingSeconds = 15 * 60; // 15åˆ†é’Ÿ

  // æ¸²æŸ“è®¢å•ä¿¡æ¯
  function renderOrderInfo() {
    document.getElementById('orderNo').textContent = orderData.orderNo;
    document.getElementById('serviceIcon').textContent = orderData.serviceIcon;
    document.getElementById('serviceName').textContent = orderData.serviceName;
    document.getElementById('techName').textContent = orderData.techName;
    
    const price = parseFloat(orderData.price).toFixed(2);
    document.getElementById('payAmount').textContent = 'Â¥' + price;
    document.getElementById('payBtn').textContent = price;
  }

  // åˆå§‹åŒ–æ”¯ä»˜æ–¹å¼é€‰æ‹©
  function initPayMethods() {
    const methods = document.querySelectorAll('.pay-method');
    methods.forEach(method => {
      method.addEventListener('click', () => {
        methods.forEach(m => m.classList.remove('active'));
        method.classList.add('active');
        method.querySelector('input').checked = true;
      });
    });
  }

  // å¼€å§‹å€’è®¡æ—¶
  function startCountdown() {
    updateCountdownDisplay();
    
    countdownTimer = setInterval(() => {
      remainingSeconds--;
      
      if (remainingSeconds <= 0) {
        clearInterval(countdownTimer);
        handleTimeout();
        return;
      }
      
      updateCountdownDisplay();
    }, 1000);
  }

  // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
  function updateCountdownDisplay() {
    const minutes = Math.floor(remainingSeconds / 60);
    const seconds = remainingSeconds % 60;
    document.getElementById('countdown').textContent = 
      `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }

  // å¤„ç†è¶…æ—¶
  function handleTimeout() {
    paymentStatus = 'timeout';
    showPayResult(false, 'æ”¯ä»˜è¶…æ—¶', 'è®¢å•å·²è‡ªåŠ¨å–æ¶ˆï¼Œè¯·é‡æ–°ä¸‹å•');
  }

  // å–æ¶ˆè®¢å•
  window.cancelOrder = function() {
    if (paymentStatus !== 'pending') return;
    
    if (confirm('ç¡®å®šè¦å–æ¶ˆè®¢å•å—ï¼Ÿ')) {
      clearInterval(countdownTimer);
      
      // æ›´æ–°è®¢å•çŠ¶æ€
      orderData.status = 6; // å·²å–æ¶ˆ
      sessionStorage.setItem('currentOrder', JSON.stringify(orderData));
      
      QY.showToast('è®¢å•å·²å–æ¶ˆ');
      setTimeout(() => QY.navigateTo('home'), 1500);
    }
  };

  // ç¡®è®¤æ”¯ä»˜
  window.confirmPay = function() {
    if (paymentStatus !== 'pending') return;
    
    paymentStatus = 'processing';
    
    // è·å–é€‰ä¸­çš„æ”¯ä»˜æ–¹å¼
    const selectedMethod = document.querySelector('input[name="payMethod"]:checked').value;
    
    // æ˜¾ç¤ºåŠ è½½
    showLoading('æ­£åœ¨å¤„ç†æ”¯ä»˜...');
    
    // æ¨¡æ‹Ÿæ”¯ä»˜è¿‡ç¨‹ï¼ˆDemoé˜¶æ®µï¼‰
    simulatePayment(selectedMethod);
  };

  // æ¨¡æ‹Ÿæ”¯ä»˜
  function simulatePayment(method) {
    // æ¨¡æ‹Ÿæ”¯ä»˜å»¶è¿Ÿ
    setTimeout(() => {
      hideLoading();
      
      // Demoé˜¶æ®µï¼š90%æ¦‚ç‡æˆåŠŸï¼Œ10%æ¦‚ç‡å¤±è´¥
      const isSuccess = Math.random() > 0.1;
      
      if (isSuccess) {
        handlePaymentSuccess(method);
      } else {
        handlePaymentFailed('æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }, 2000);
  }

  // å¤„ç†æ”¯ä»˜æˆåŠŸ
  function handlePaymentSuccess(method) {
    clearInterval(countdownTimer);
    paymentStatus = 'success';
    
    // æ›´æ–°è®¢å•çŠ¶æ€
    orderData.status = 1; // å·²æ”¯ä»˜/å¾…æ¥å•
    orderData.payMethod = method;
    orderData.payTime = new Date().toISOString();
    orderData.payTransactionId = 'PAY' + Date.now();
    
    sessionStorage.setItem('currentOrder', JSON.stringify(orderData));
    
    // æ˜¾ç¤ºæˆåŠŸç»“æœ
    showPayResult(true, 'æ”¯ä»˜æˆåŠŸ', 'è®¢å•å·²æäº¤ï¼Œç­‰å¾…æŠ€å¸ˆæ¥å•');
  }

  // å¤„ç†æ”¯ä»˜å¤±è´¥
  function handlePaymentFailed(reason) {
    paymentStatus = 'pending'; // å…è®¸é‡è¯•
    
    // æ˜¾ç¤ºå¤±è´¥ç»“æœ
    showPayResult(false, 'æ”¯ä»˜å¤±è´¥', reason);
  }

  // æ˜¾ç¤ºæ”¯ä»˜ç»“æœ
  function showPayResult(success, title, desc) {
    const modal = document.getElementById('payResultModal');
    const icon = document.getElementById('resultIcon');
    const titleEl = document.getElementById('resultTitle');
    const descEl = document.getElementById('resultDesc');
    
    icon.textContent = success ? 'âœ…' : 'âŒ';
    icon.className = 'result-icon ' + (success ? 'success' : 'fail');
    titleEl.textContent = title;
    descEl.textContent = desc;
    
    modal.style.display = 'flex';
  }

  // æŸ¥çœ‹è®¢å•
  window.viewOrder = function() {
    document.getElementById('payResultModal').style.display = 'none';
    QY.navigateTo('order/detail', { orderNo: orderData.orderNo });
  };

  // è¿”å›é¦–é¡µ
  window.backToHome = function() {
    document.getElementById('payResultModal').style.display = 'none';
    
    if (paymentStatus === 'success') {
      QY.navigateTo('home');
    } else {
      // æ”¯ä»˜å¤±è´¥æˆ–è¶…æ—¶ï¼Œå…è®¸é‡è¯•
      paymentStatus = 'pending';
    }
  };

  // æ˜¾ç¤ºåŠ è½½
  function showLoading(text) {
    const overlay = document.createElement('div');
    overlay.className = 'loading-overlay';
    overlay.id = 'loadingOverlay';
    overlay.innerHTML = `
      <div class="loading-content">
        <div class="loading-spinner">â³</div>
        <div class="loading-text">${text}</div>
      </div>
    `;
    document.body.appendChild(overlay);
  }

  // éšè—åŠ è½½
  function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
      overlay.remove();
    }
  }

  // é¡µé¢å¸è½½æ—¶æ¸…ç†
  window.addEventListener('beforeunload', () => {
    if (countdownTimer) {
      clearInterval(countdownTimer);
    }
  });

  // åˆå§‹åŒ–
  renderOrderInfo();
  initPayMethods();
  startCountdown();

})();
</script>
