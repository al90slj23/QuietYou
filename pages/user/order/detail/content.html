<div class="order-detail-page" id="orderDetailPage">
  <!-- è®¢å•çŠ¶æ€å¤´éƒ¨ -->
  <div class="status-header" id="statusHeader">
    <div class="status-icon" id="statusIcon">â³</div>
    <div class="status-text" id="statusText">å¾…æ”¯ä»˜</div>
    <div class="status-desc" id="statusDesc">è¯·åœ¨15åˆ†é’Ÿå†…å®Œæˆæ”¯ä»˜</div>
  </div>

  <!-- æŠ€å¸ˆä½ç½®åœ°å›¾ï¼ˆè¿›è¡Œä¸­çŠ¶æ€æ˜¾ç¤ºï¼‰ -->
  <div class="map-section card" id="mapSection" style="display: none;">
    <div class="section-title">æŠ€å¸ˆä½ç½®</div>
    <div class="map-container" id="mapContainer">
      <div class="map-placeholder">
        <span class="map-icon">ğŸ—ºï¸</span>
        <span class="map-text">æŠ€å¸ˆæ­£åœ¨å‰å¾€ä¸­...</span>
        <span class="map-distance" id="techDistance">è·ç¦»æ‚¨çº¦ 2.5 å…¬é‡Œ</span>
      </div>
    </div>
  </div>

  <!-- æœåŠ¡ä¿¡æ¯ -->
  <div class="section card">
    <div class="section-title">æœåŠ¡ä¿¡æ¯</div>
    <div class="service-info">
      <div class="service-icon" id="serviceIcon">ğŸ’†</div>
      <div class="service-detail">
        <div class="service-name" id="serviceName">å…¨èº«ä¸­å¼æ¨æ‹¿</div>
        <div class="service-duration" id="serviceDuration">60åˆ†é’Ÿ</div>
      </div>
      <div class="service-price" id="servicePrice">Â¥298</div>
    </div>
  </div>

  <!-- æŠ€å¸ˆä¿¡æ¯ -->
  <div class="section card">
    <div class="section-title">æŠ€å¸ˆä¿¡æ¯</div>
    <div class="tech-info" onclick="viewTechDetail()">
      <div class="tech-avatar" id="techAvatar">ğŸ‘¨</div>
      <div class="tech-detail">
        <div class="tech-name" id="techName">å¼ å¸ˆå‚…</div>
        <div class="tech-rating">
          <span class="rating-star">â­</span>
          <span id="techRating">4.9</span>
          <span class="text-placeholder"> | </span>
          <span id="techOrders">328</span>å•
        </div>
      </div>
      <div class="tech-action">
        <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); contactTech()">
          ğŸ“ è”ç³»
        </button>
      </div>
    </div>
  </div>

  <!-- é¢„çº¦ä¿¡æ¯ -->
  <div class="section card">
    <div class="section-title">é¢„çº¦ä¿¡æ¯</div>
    <div class="info-list">
      <div class="info-item">
        <span class="info-label">é¢„çº¦æ—¶é—´</span>
        <span class="info-value" id="scheduleTime">1æœˆ12æ—¥ å‘¨æ—¥ 14:00</span>
      </div>
      <div class="info-item">
        <span class="info-label">è”ç³»äºº</span>
        <span class="info-value" id="contactName">å¼ ä¸‰</span>
      </div>
      <div class="info-item">
        <span class="info-label">è”ç³»ç”µè¯</span>
        <span class="info-value" id="contactPhone">138****8001</span>
      </div>
      <div class="info-item address">
        <span class="info-label">æœåŠ¡åœ°å€</span>
        <span class="info-value" id="address">åŒ—äº¬å¸‚æœé˜³åŒºå»ºå›½è·¯88å·SOHOç°ä»£åŸAåº§1201</span>
      </div>
    </div>
  </div>

  <!-- è®¢å•ä¿¡æ¯ -->
  <div class="section card">
    <div class="section-title">è®¢å•ä¿¡æ¯</div>
    <div class="info-list">
      <div class="info-item">
        <span class="info-label">è®¢å•ç¼–å·</span>
        <span class="info-value order-no" id="orderNo">QY20260111143000A1B2</span>
      </div>
      <div class="info-item">
        <span class="info-label">ä¸‹å•æ—¶é—´</span>
        <span class="info-value" id="createTime">2026-01-11 14:30:00</span>
      </div>
      <div class="info-item" id="payTimeRow" style="display: none;">
        <span class="info-label">æ”¯ä»˜æ—¶é—´</span>
        <span class="info-value" id="payTime">-</span>
      </div>
      <div class="info-item" id="cancelTimeRow" style="display: none;">
        <span class="info-label">å–æ¶ˆæ—¶é—´</span>
        <span class="info-value" id="cancelTime">-</span>
      </div>
      <div class="info-item" id="cancelReasonRow" style="display: none;">
        <span class="info-label">å–æ¶ˆåŸå› </span>
        <span class="info-value" id="cancelReason">-</span>
      </div>
    </div>
  </div>

  <!-- è´¹ç”¨æ˜ç»† -->
  <div class="section card">
    <div class="section-title">è´¹ç”¨æ˜ç»†</div>
    <div class="price-detail">
      <div class="price-row">
        <span class="price-label">æœåŠ¡è´¹</span>
        <span class="price-value" id="priceService">Â¥298</span>
      </div>
      <div class="price-row">
        <span class="price-label">ä¼˜æƒ </span>
        <span class="price-value discount" id="priceDiscount">-Â¥0</span>
      </div>
      <div class="price-row total">
        <span class="price-label">å®ä»˜é‡‘é¢</span>
        <span class="price-value" id="priceTotal">Â¥298</span>
      </div>
    </div>
  </div>

  <!-- å¤‡æ³¨ -->
  <div class="section card" id="remarkSection" style="display: none;">
    <div class="section-title">å¤‡æ³¨</div>
    <div class="remark-content" id="remarkContent"></div>
  </div>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <div class="bottom-bar" id="bottomBar">
    <!-- åŠ¨æ€æ¸²æŸ“ -->
  </div>
</div>

<!-- è¯„ä»·å¼¹çª— -->
<div class="review-modal" id="reviewModal" style="display: none;">
  <div class="modal-overlay" onclick="closeReviewModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <span class="modal-title">è¯„ä»·æœåŠ¡</span>
      <span class="modal-close" onclick="closeReviewModal()">âœ•</span>
    </div>
    <div class="modal-body">
      <div class="rating-section">
        <div class="rating-label">æœåŠ¡è¯„åˆ†</div>
        <div class="rating-stars" id="ratingStars">
          <span class="star" data-value="1" onclick="setRating(1)">â˜†</span>
          <span class="star" data-value="2" onclick="setRating(2)">â˜†</span>
          <span class="star" data-value="3" onclick="setRating(3)">â˜†</span>
          <span class="star" data-value="4" onclick="setRating(4)">â˜†</span>
          <span class="star" data-value="5" onclick="setRating(5)">â˜†</span>
        </div>
        <div class="rating-text" id="ratingText">ç‚¹å‡»è¯„åˆ†</div>
      </div>
      <div class="review-section">
        <div class="review-label">è¯„ä»·å†…å®¹ï¼ˆé€‰å¡«ï¼‰</div>
        <textarea class="review-textarea" id="reviewContent" placeholder="åˆ†äº«æ‚¨çš„æœåŠ¡ä½“éªŒ..." maxlength="500"></textarea>
        <div class="char-count"><span id="charCount">0</span>/500</div>
      </div>
      <div class="photo-section">
        <div class="photo-label">ä¸Šä¼ å›¾ç‰‡ï¼ˆé€‰å¡«ï¼Œæœ€å¤š3å¼ ï¼‰</div>
        <div class="photo-list" id="photoList">
          <div class="photo-add" onclick="addPhoto()">
            <span class="add-icon">+</span>
            <span class="add-text">æ·»åŠ å›¾ç‰‡</span>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary btn-block" onclick="submitReview()">æäº¤è¯„ä»·</button>
    </div>
  </div>
</div>

<style>
.order-detail-page {
  background: var(--bg-color);
  min-height: 100%;
  padding-bottom: 80px;
}

/* Status Header */
.status-header {
  background: linear-gradient(135deg, var(--primary-color) 0%, #10b981 100%);
  padding: 24px 16px;
  text-align: center;
  color: #fff;
}

.status-header.pending { background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); }
.status-header.paid { background: linear-gradient(135deg, var(--primary-color) 0%, #10b981 100%); }
.status-header.in-progress { background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); }
.status-header.completed { background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%); }
.status-header.cancelled { background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%); }

.status-icon {
  font-size: 48px;
  margin-bottom: 8px;
}

.status-text {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 4px;
}

.status-desc {
  font-size: 14px;
  opacity: 0.9;
}

/* Map Section */
.map-section {
  margin: 12px;
}

.map-container {
  height: 150px;
  background: var(--bg-color);
  border-radius: 8px;
  overflow: hidden;
}

.map-placeholder {
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.map-icon {
  font-size: 36px;
  margin-bottom: 8px;
}

.map-text {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 4px;
}

.map-distance {
  font-size: 13px;
  color: var(--primary-color);
  font-weight: 500;
}

/* Section */
.section {
  margin: 12px;
}

.section-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 12px;
}

/* Service Info */
.service-info {
  display: flex;
  align-items: center;
}

.service-icon {
  width: 48px;
  height: 48px;
  border-radius: 8px;
  background: var(--primary-light);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  margin-right: 12px;
}

.service-detail {
  flex: 1;
}

.service-name {
  font-size: 15px;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.service-duration {
  font-size: 12px;
  color: var(--text-placeholder);
}

.service-price {
  font-size: 18px;
  font-weight: 600;
  color: var(--danger-color);
}

/* Tech Info */
.tech-info {
  display: flex;
  align-items: center;
  cursor: pointer;
}

.tech-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--bg-color);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  margin-right: 12px;
}

.tech-detail {
  flex: 1;
}

.tech-name {
  font-size: 15px;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.tech-rating {
  font-size: 12px;
  color: var(--text-secondary);
}

.rating-star {
  color: var(--warning-color);
}

.btn-sm {
  padding: 6px 12px;
  font-size: 12px;
}

/* Info List */
.info-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.info-item {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.info-item.address {
  flex-direction: column;
  gap: 4px;
}

.info-label {
  font-size: 13px;
  color: var(--text-placeholder);
  flex-shrink: 0;
}

.info-value {
  font-size: 14px;
  color: var(--text-primary);
  text-align: right;
}

.info-item.address .info-value {
  text-align: left;
  line-height: 1.5;
}

.order-no {
  font-family: monospace;
  font-size: 12px;
}

/* Price Detail */
.price-detail {
  margin-top: 8px;
}

.price-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
}

.price-row .price-label {
  font-size: 14px;
  color: var(--text-secondary);
}

.price-row .price-value {
  font-size: 14px;
  color: var(--text-primary);
}

.price-row .price-value.discount {
  color: var(--primary-color);
}

.price-row.total {
  border-top: 1px solid var(--border-color);
  margin-top: 8px;
  padding-top: 12px;
}

.price-row.total .price-label {
  font-size: 15px;
  font-weight: 500;
  color: var(--text-primary);
}

.price-row.total .price-value {
  font-size: 18px;
  font-weight: 600;
  color: var(--danger-color);
}

/* Remark */
.remark-content {
  font-size: 14px;
  color: var(--text-secondary);
  line-height: 1.6;
  padding: 12px;
  background: var(--bg-color);
  border-radius: 6px;
}

/* Bottom Bar */
.bottom-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 70px;
  background: var(--bg-white);
  border-top: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding: 0 16px;
  gap: 12px;
  z-index: 100;
}

.bottom-bar .btn {
  padding: 12px 24px;
  font-size: 15px;
  border-radius: 24px;
}

/* Review Modal */
.review-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 1000;
}

.modal-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
}

.modal-content {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bg-white);
  border-radius: 16px 16px 0 0;
  max-height: 80vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  border-bottom: 1px solid var(--border-color);
}

.modal-title {
  font-size: 17px;
  font-weight: 600;
}

.modal-close {
  font-size: 20px;
  color: var(--text-placeholder);
  cursor: pointer;
}

.modal-body {
  padding: 16px;
}

.modal-footer {
  padding: 16px;
  border-top: 1px solid var(--border-color);
}

/* Rating Section */
.rating-section {
  text-align: center;
  margin-bottom: 24px;
}

.rating-label {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 12px;
}

.rating-stars {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 8px;
}

.rating-stars .star {
  font-size: 32px;
  color: var(--border-color);
  cursor: pointer;
  transition: color 0.2s;
}

.rating-stars .star.active {
  color: var(--warning-color);
}

.rating-text {
  font-size: 13px;
  color: var(--text-placeholder);
}

/* Review Section */
.review-section {
  margin-bottom: 16px;
}

.review-label {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

.review-textarea {
  width: 100%;
  height: 100px;
  padding: 12px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  font-size: 14px;
  resize: none;
  outline: none;
}

.review-textarea:focus {
  border-color: var(--primary-color);
}

.char-count {
  text-align: right;
  font-size: 12px;
  color: var(--text-placeholder);
  margin-top: 4px;
}

/* Photo Section */
.photo-section {
  margin-bottom: 16px;
}

.photo-label {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

.photo-list {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.photo-add {
  width: 80px;
  height: 80px;
  border: 1px dashed var(--border-color);
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.add-icon {
  font-size: 24px;
  color: var(--text-placeholder);
}

.add-text {
  font-size: 11px;
  color: var(--text-placeholder);
}

.photo-item {
  width: 80px;
  height: 80px;
  border-radius: 8px;
  background: var(--bg-color);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  position: relative;
}

.photo-remove {
  position: absolute;
  top: -6px;
  right: -6px;
  width: 20px;
  height: 20px;
  background: var(--danger-color);
  color: #fff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  cursor: pointer;
}
</style>


<script>
(function() {
  // è·å–å‚æ•°
  const params = QY.getParams();
  const orderNo = params.orderNo;
  const action = params.action;

  // è®¢å•çŠ¶æ€æ˜ å°„
  const STATUS_CONFIG = {
    0: { text: 'å¾…æ”¯ä»˜', desc: 'è¯·åœ¨15åˆ†é’Ÿå†…å®Œæˆæ”¯ä»˜', icon: 'â³', class: 'pending' },
    1: { text: 'å¾…æ¥å•', desc: 'ç­‰å¾…æŠ€å¸ˆæ¥å•', icon: 'ğŸ“‹', class: 'paid' },
    2: { text: 'å¾…æœåŠ¡', desc: 'æŠ€å¸ˆå·²æ¥å•ï¼Œè¯·å‡†æ—¶ç­‰å€™', icon: 'âœ…', class: 'paid' },
    3: { text: 'æŠ€å¸ˆå‡ºå‘ä¸­', desc: 'æŠ€å¸ˆæ­£åœ¨å‰å¾€æ‚¨çš„ä½ç½®', icon: 'ğŸš—', class: 'in-progress' },
    4: { text: 'æœåŠ¡ä¸­', desc: 'æœåŠ¡è¿›è¡Œä¸­ï¼Œè¯·äº«å—æœåŠ¡', icon: 'ğŸ’†', class: 'in-progress' },
    5: { text: 'å·²å®Œæˆ', desc: 'æœåŠ¡å·²å®Œæˆï¼Œæ„Ÿè°¢æ‚¨çš„ä½¿ç”¨', icon: 'ğŸ‰', class: 'completed' },
    6: { text: 'å·²å–æ¶ˆ', desc: 'è®¢å•å·²å–æ¶ˆ', icon: 'âŒ', class: 'cancelled' },
    7: { text: 'å·²é€€æ¬¾', desc: 'é€€æ¬¾å·²å¤„ç†', icon: 'ğŸ’°', class: 'cancelled' }
  };

  // Mock è®¢å•æ•°æ®
  const mockOrder = {
    orderNo: orderNo || 'QY20260111143000A1B2',
    status: 2,
    serviceName: 'å…¨èº«ä¸­å¼æ¨æ‹¿',
    serviceIcon: 'ğŸ’†',
    duration: 60,
    techId: 1,
    techName: 'å¼ å¸ˆå‚…',
    techAvatar: 'ğŸ‘¨',
    techRating: 4.9,
    techOrders: 328,
    price: 298,
    discount: 0,
    totalPrice: 298,
    scheduleDate: '2026-01-12',
    scheduleTime: '14:00',
    contactName: 'å¼ ä¸‰',
    contactPhone: '13800138001',
    address: 'åŒ—äº¬å¸‚æœé˜³åŒºå»ºå›½è·¯88å·SOHOç°ä»£åŸAåº§1201',
    remark: '',
    createTime: '2026-01-11 14:30:00',
    payTime: '2026-01-11 14:32:00',
    cancelTime: null,
    cancelReason: null,
    hasReview: false
  };

  let order = mockOrder;
  let currentRating = 0;
  let reviewPhotos = [];

  // æ¸²æŸ“è®¢å•çŠ¶æ€å¤´éƒ¨
  function renderStatusHeader() {
    const config = STATUS_CONFIG[order.status];
    const header = document.getElementById('statusHeader');
    
    header.className = 'status-header ' + config.class;
    document.getElementById('statusIcon').textContent = config.icon;
    document.getElementById('statusText').textContent = config.text;
    document.getElementById('statusDesc').textContent = config.desc;
    
    // æ˜¾ç¤ºåœ°å›¾ï¼ˆè¿›è¡Œä¸­çŠ¶æ€ï¼‰
    if (order.status === 3 || order.status === 4) {
      document.getElementById('mapSection').style.display = 'block';
    }
  }

  // æ¸²æŸ“æœåŠ¡ä¿¡æ¯
  function renderServiceInfo() {
    document.getElementById('serviceIcon').textContent = order.serviceIcon;
    document.getElementById('serviceName').textContent = order.serviceName;
    document.getElementById('serviceDuration').textContent = order.duration + 'åˆ†é’Ÿ';
    document.getElementById('servicePrice').textContent = 'Â¥' + order.price;
  }

  // æ¸²æŸ“æŠ€å¸ˆä¿¡æ¯
  function renderTechInfo() {
    document.getElementById('techAvatar').textContent = order.techAvatar;
    document.getElementById('techName').textContent = order.techName;
    document.getElementById('techRating').textContent = order.techRating;
    document.getElementById('techOrders').textContent = order.techOrders;
  }

  // æ¸²æŸ“é¢„çº¦ä¿¡æ¯
  function renderBookingInfo() {
    const [year, month, day] = order.scheduleDate.split('-');
    const d = new Date(order.scheduleDate);
    const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
    
    document.getElementById('scheduleTime').textContent = 
      `${month}æœˆ${day}æ—¥ ${dayNames[d.getDay()]} ${order.scheduleTime}`;
    document.getElementById('contactName').textContent = order.contactName;
    document.getElementById('contactPhone').textContent = maskPhone(order.contactPhone);
    document.getElementById('address').textContent = order.address;
  }

  // æ¸²æŸ“è®¢å•ä¿¡æ¯
  function renderOrderInfo() {
    document.getElementById('orderNo').textContent = order.orderNo;
    document.getElementById('createTime').textContent = order.createTime;
    
    if (order.payTime) {
      document.getElementById('payTimeRow').style.display = 'flex';
      document.getElementById('payTime').textContent = order.payTime;
    }
    
    if (order.cancelTime) {
      document.getElementById('cancelTimeRow').style.display = 'flex';
      document.getElementById('cancelTime').textContent = order.cancelTime;
    }
    
    if (order.cancelReason) {
      document.getElementById('cancelReasonRow').style.display = 'flex';
      document.getElementById('cancelReason').textContent = order.cancelReason;
    }
  }

  // æ¸²æŸ“è´¹ç”¨æ˜ç»†
  function renderPriceDetail() {
    document.getElementById('priceService').textContent = 'Â¥' + order.price;
    document.getElementById('priceDiscount').textContent = '-Â¥' + order.discount;
    document.getElementById('priceTotal').textContent = 'Â¥' + order.totalPrice;
  }

  // æ¸²æŸ“å¤‡æ³¨
  function renderRemark() {
    if (order.remark) {
      document.getElementById('remarkSection').style.display = 'block';
      document.getElementById('remarkContent').textContent = order.remark;
    }
  }

  // æ¸²æŸ“åº•éƒ¨æ“ä½œæ 
  function renderBottomBar() {
    const bar = document.getElementById('bottomBar');
    let html = '';
    
    switch (order.status) {
      case 0: // å¾…æ”¯ä»˜
        html = `
          <button class="btn btn-secondary" onclick="cancelOrder()">å–æ¶ˆè®¢å•</button>
          <button class="btn btn-primary" onclick="payOrder()">å»æ”¯ä»˜</button>
        `;
        break;
      case 1: // å¾…æ¥å•
      case 2: // å¾…æœåŠ¡
        html = `
          <button class="btn btn-secondary" onclick="cancelOrder()">å–æ¶ˆè®¢å•</button>
          <button class="btn btn-primary" onclick="contactTech()">è”ç³»æŠ€å¸ˆ</button>
        `;
        break;
      case 3: // æŠ€å¸ˆå‡ºå‘ä¸­
      case 4: // æœåŠ¡ä¸­
        html = `
          <button class="btn btn-primary" onclick="contactTech()">è”ç³»æŠ€å¸ˆ</button>
        `;
        break;
      case 5: // å·²å®Œæˆ
        if (!order.hasReview) {
          html = `
            <button class="btn btn-secondary" onclick="rebookOrder()">å†æ¬¡é¢„çº¦</button>
            <button class="btn btn-primary" onclick="openReviewModal()">å»è¯„ä»·</button>
          `;
        } else {
          html = `
            <button class="btn btn-primary" onclick="rebookOrder()">å†æ¬¡é¢„çº¦</button>
          `;
        }
        break;
      case 6: // å·²å–æ¶ˆ
      case 7: // å·²é€€æ¬¾
        html = `
          <button class="btn btn-primary" onclick="rebookOrder()">å†æ¬¡é¢„çº¦</button>
        `;
        break;
    }
    
    bar.innerHTML = html;
  }

  // æ‰‹æœºå·è„±æ•
  function maskPhone(phone) {
    if (!phone || phone.length < 7) return phone;
    return phone.substring(0, 3) + '****' + phone.substring(7);
  }

  // æŸ¥çœ‹æŠ€å¸ˆè¯¦æƒ…
  window.viewTechDetail = function() {
    QY.navigateTo('technician/detail', { id: order.techId });
  };

  // è”ç³»æŠ€å¸ˆ
  window.contactTech = function() {
    QY.showToast('æ­£åœ¨å‘¼å«æŠ€å¸ˆ...');
  };

  // å–æ¶ˆè®¢å•
  window.cancelOrder = function() {
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥å–æ¶ˆï¼ˆä»…å¾…æ”¯ä»˜ã€å¾…æ¥å•ã€å¾…æœåŠ¡çŠ¶æ€å¯å–æ¶ˆï¼‰
    if (![0, 1, 2].includes(order.status)) {
      QY.showToast('å½“å‰çŠ¶æ€æ— æ³•å–æ¶ˆè®¢å•');
      return;
    }
    
    if (confirm('ç¡®å®šè¦å–æ¶ˆè®¢å•å—ï¼Ÿ')) {
      order.status = 6;
      order.cancelTime = new Date().toISOString().replace('T', ' ').substring(0, 19);
      order.cancelReason = 'ç”¨æˆ·å–æ¶ˆ';
      
      renderStatusHeader();
      renderOrderInfo();
      renderBottomBar();
      
      QY.showToast('è®¢å•å·²å–æ¶ˆ');
    }
  };

  // å»æ”¯ä»˜
  window.payOrder = function() {
    sessionStorage.setItem('currentOrder', JSON.stringify(order));
    QY.navigateTo('order/pay', { orderNo: order.orderNo });
  };

  // å†æ¬¡é¢„çº¦
  window.rebookOrder = function() {
    QY.navigateTo('technician/detail', { id: order.techId });
  };

  // æ‰“å¼€è¯„ä»·å¼¹çª—
  window.openReviewModal = function() {
    document.getElementById('reviewModal').style.display = 'block';
    currentRating = 0;
    reviewPhotos = [];
    updateRatingDisplay();
  };

  // å…³é—­è¯„ä»·å¼¹çª—
  window.closeReviewModal = function() {
    document.getElementById('reviewModal').style.display = 'none';
  };

  // è®¾ç½®è¯„åˆ†
  window.setRating = function(rating) {
    currentRating = rating;
    updateRatingDisplay();
  };

  // æ›´æ–°è¯„åˆ†æ˜¾ç¤º
  function updateRatingDisplay() {
    const stars = document.querySelectorAll('.rating-stars .star');
    const ratingTexts = ['', 'éå¸¸å·®', 'è¾ƒå·®', 'ä¸€èˆ¬', 'æ»¡æ„', 'éå¸¸æ»¡æ„'];
    
    stars.forEach((star, index) => {
      if (index < currentRating) {
        star.classList.add('active');
        star.textContent = 'â˜…';
      } else {
        star.classList.remove('active');
        star.textContent = 'â˜†';
      }
    });
    
    document.getElementById('ratingText').textContent = 
      currentRating > 0 ? ratingTexts[currentRating] : 'ç‚¹å‡»è¯„åˆ†';
  }

  // æ·»åŠ å›¾ç‰‡
  window.addPhoto = function() {
    if (reviewPhotos.length >= 3) {
      QY.showToast('æœ€å¤šä¸Šä¼ 3å¼ å›¾ç‰‡');
      return;
    }
    
    // æ¨¡æ‹Ÿæ·»åŠ å›¾ç‰‡
    reviewPhotos.push('ğŸ“·');
    renderPhotoList();
  };

  // ç§»é™¤å›¾ç‰‡
  window.removePhoto = function(index) {
    reviewPhotos.splice(index, 1);
    renderPhotoList();
  };

  // æ¸²æŸ“å›¾ç‰‡åˆ—è¡¨
  function renderPhotoList() {
    const container = document.getElementById('photoList');
    let html = reviewPhotos.map((photo, index) => `
      <div class="photo-item">
        ${photo}
        <span class="photo-remove" onclick="removePhoto(${index})">âœ•</span>
      </div>
    `).join('');
    
    if (reviewPhotos.length < 3) {
      html += `
        <div class="photo-add" onclick="addPhoto()">
          <span class="add-icon">+</span>
          <span class="add-text">æ·»åŠ å›¾ç‰‡</span>
        </div>
      `;
    }
    
    container.innerHTML = html;
  }

  // æäº¤è¯„ä»·
  window.submitReview = function() {
    if (currentRating === 0) {
      QY.showToast('è¯·é€‰æ‹©è¯„åˆ†');
      return;
    }
    
    const content = document.getElementById('reviewContent').value.trim();
    
    // æ¨¡æ‹Ÿæäº¤
    QY.showToast('è¯„ä»·æäº¤æˆåŠŸ');
    order.hasReview = true;
    closeReviewModal();
    renderBottomBar();
  };

  // ç›‘å¬è¯„ä»·å†…å®¹è¾“å…¥
  document.getElementById('reviewContent').addEventListener('input', function() {
    document.getElementById('charCount').textContent = this.value.length;
  });

  // åˆå§‹åŒ–
  renderStatusHeader();
  renderServiceInfo();
  renderTechInfo();
  renderBookingInfo();
  renderOrderInfo();
  renderPriceDetail();
  renderRemark();
  renderBottomBar();

  // å¦‚æœå¸¦æœ‰è¯„ä»·åŠ¨ä½œï¼Œè‡ªåŠ¨æ‰“å¼€è¯„ä»·å¼¹çª—
  if (action === 'review' && order.status === 5 && !order.hasReview) {
    setTimeout(openReviewModal, 500);
  }

})();
</script>
