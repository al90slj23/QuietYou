<div class="page-container tech-order-detail">
  <!-- è®¢å•çŠ¶æ€è¿›åº¦ -->
  <div class="card order-progress-card">
    <div class="order-status-header">
      <span class="order-status-text" id="statusText">å¾…æœåŠ¡</span>
      <span class="order-status-desc" id="statusDesc">è¯·æŒ‰æ—¶åˆ°è¾¾æœåŠ¡åœ°ç‚¹</span>
    </div>
    <div class="order-progress" id="orderProgress">
      <div class="progress-step completed">
        <div class="step-dot"></div>
        <div class="step-label">å·²æ¥å•</div>
      </div>
      <div class="progress-line"></div>
      <div class="progress-step" id="step-depart">
        <div class="step-dot"></div>
        <div class="step-label">å‡ºå‘</div>
      </div>
      <div class="progress-line"></div>
      <div class="progress-step" id="step-arrive">
        <div class="step-dot"></div>
        <div class="step-label">åˆ°è¾¾</div>
      </div>
      <div class="progress-line"></div>
      <div class="progress-step" id="step-start">
        <div class="step-dot"></div>
        <div class="step-label">å¼€å§‹æœåŠ¡</div>
      </div>
      <div class="progress-line"></div>
      <div class="progress-step" id="step-complete">
        <div class="step-dot"></div>
        <div class="step-label">å®Œæˆ</div>
      </div>
    </div>
  </div>

  <!-- å®¢æˆ·ä¿¡æ¯ -->
  <div class="card">
    <div class="card-title">å®¢æˆ·ä¿¡æ¯</div>
    <div class="customer-info">
      <div class="customer-row">
        <span class="customer-label">å®¢æˆ·å§“å</span>
        <span class="customer-value" id="customerName">æ**</span>
      </div>
      <div class="customer-row">
        <span class="customer-label">è”ç³»ç”µè¯</span>
        <span class="customer-value">
          <span id="customerPhone">138****8888</span>
          <button class="btn-link" onclick="callCustomer()">ğŸ“ æ‹¨æ‰“</button>
        </span>
      </div>
      <div class="customer-row">
        <span class="customer-label">æœåŠ¡åœ°å€</span>
        <span class="customer-value">
          <span id="customerAddress">æœé˜³åŒºå»ºå›½è·¯88å·SOHOç°ä»£åŸAåº§1205</span>
          <button class="btn-link" onclick="openNavigation()"><t-icon name="map" size="14px" /> å¯¼èˆª</button>
        </span>
      </div>
    </div>
  </div>

  <!-- æœåŠ¡ä¿¡æ¯ -->
  <div class="card">
    <div class="card-title">æœåŠ¡ä¿¡æ¯</div>
    <div class="service-info">
      <div class="service-row">
        <span class="service-label">æœåŠ¡é¡¹ç›®</span>
        <span class="service-value" id="serviceName">ä¸­å¼æ¨æ‹¿ 60åˆ†é’Ÿ</span>
      </div>
      <div class="service-row">
        <span class="service-label">é¢„çº¦æ—¶é—´</span>
        <span class="service-value" id="serviceTime">2026-01-11 14:00</span>
      </div>
      <div class="service-row">
        <span class="service-label">æœåŠ¡æ—¶é•¿</span>
        <span class="service-value" id="serviceDuration">60åˆ†é’Ÿ</span>
      </div>
      <div class="service-row">
        <span class="service-label">è®¢å•é‡‘é¢</span>
        <span class="service-value price" id="servicePrice">298</span>
      </div>
      <div class="service-row">
        <span class="service-label">é¢„è®¡æ”¶å…¥</span>
        <span class="service-value text-success" id="expectedIncome">Â¥238.40</span>
      </div>
    </div>
  </div>

  <!-- æœåŠ¡è®¡æ—¶å™¨ï¼ˆè¿›è¡Œä¸­æ˜¾ç¤ºï¼‰ -->
  <div class="card service-timer-card" id="timerCard" style="display:none;">
    <div class="card-title">æœåŠ¡è®¡æ—¶</div>
    <div class="timer-display">
      <span class="timer-value" id="timerValue">00:00:00</span>
    </div>
    <div class="timer-info">
      <span>å¼€å§‹æ—¶é—´ï¼š<span id="startTime">--:--</span></span>
      <span>é¢„è®¡ç»“æŸï¼š<span id="endTime">--:--</span></span>
    </div>
  </div>

  <!-- è®¢å•å¤‡æ³¨ -->
  <div class="card">
    <div class="card-title">è®¢å•å¤‡æ³¨</div>
    <div class="order-remark" id="orderRemark">
      å®¢æˆ·è¦æ±‚ï¼šåŠ›åº¦é€‚ä¸­ï¼Œé‡ç‚¹æŒ‰æ‘©è‚©é¢ˆéƒ¨ä½
    </div>
  </div>

  <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
  <div class="bottom-actions" id="bottomActions">
    <!-- åŠ¨æ€ç”Ÿæˆ -->
  </div>
</div>

<style>
.tech-order-detail {
  padding-bottom: 80px;
}

.order-progress-card {
  background: linear-gradient(135deg, var(--primary-color) 0%, #1976d2 100%);
  color: #fff;
}

.order-status-header {
  text-align: center;
  margin-bottom: 20px;
}

.order-status-text {
  font-size: 20px;
  font-weight: 600;
  display: block;
  margin-bottom: 4px;
}

.order-status-desc {
  font-size: 13px;
  opacity: 0.8;
}

.order-progress {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 8px;
}

.progress-step {
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
}

.step-dot {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: rgba(255,255,255,0.3);
  border: 2px solid rgba(255,255,255,0.5);
  margin-bottom: 6px;
}

.progress-step.completed .step-dot {
  background: #fff;
  border-color: #fff;
}

.progress-step.active .step-dot {
  background: #4caf50;
  border-color: #fff;
  box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.3);
}

.step-label {
  font-size: 10px;
  opacity: 0.7;
  white-space: nowrap;
}

.progress-step.completed .step-label,
.progress-step.active .step-label {
  opacity: 1;
}

.progress-line {
  flex: 1;
  height: 2px;
  background: rgba(255,255,255,0.3);
  margin: 0 4px;
  margin-bottom: 20px;
}

.progress-line.completed {
  background: #fff;
}

.customer-info, .service-info {
  font-size: 14px;
}

.customer-row, .service-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 8px 0;
  border-bottom: 1px solid var(--border-color);
}

.customer-row:last-child, .service-row:last-child {
  border-bottom: none;
}

.customer-label, .service-label {
  color: var(--text-secondary);
  flex-shrink: 0;
  width: 70px;
}

.customer-value, .service-value {
  flex: 1;
  text-align: right;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 8px;
  flex-wrap: wrap;
}

.btn-link {
  background: none;
  border: none;
  color: var(--primary-color);
  font-size: 12px;
  cursor: pointer;
  padding: 2px 6px;
}

.service-timer-card {
  text-align: center;
}

.timer-display {
  padding: 20px 0;
}

.timer-value {
  font-size: 48px;
  font-weight: 600;
  color: var(--primary-color);
  font-family: 'Courier New', monospace;
}

.timer-info {
  display: flex;
  justify-content: space-around;
  font-size: 12px;
  color: var(--text-secondary);
}

.order-remark {
  font-size: 14px;
  color: var(--text-secondary);
  line-height: 1.6;
}

.bottom-actions {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 12px 16px;
  background: var(--bg-white);
  border-top: 1px solid var(--border-color);
  display: flex;
  gap: 12px;
  z-index: 100;
}

.bottom-actions .btn {
  flex: 1;
  padding: 12px;
  font-size: 16px;
}
</style>

<script>
(function() {
  // æ¨¡æ‹Ÿè®¢å•æ•°æ®
  const orderData = {
    id: 'ORD20260111001',
    service: 'ä¸­å¼æ¨æ‹¿',
    duration: 60,
    customerName: 'æ**',
    phone: '138****8888',
    address: 'æœé˜³åŒºå»ºå›½è·¯88å·SOHOç°ä»£åŸAåº§1205',
    time: '2026-01-11 14:00',
    price: 298,
    commission: 0.2, // å¹³å°æŠ½æˆ20%
    status: 'accepted', // pending, accepted, departed, arrived, in_progress, completed
    remark: 'å®¢æˆ·è¦æ±‚ï¼šåŠ›åº¦é€‚ä¸­ï¼Œé‡ç‚¹æŒ‰æ‘©è‚©é¢ˆéƒ¨ä½',
    serviceStartTime: null
  };

  // çŠ¶æ€é…ç½®
  const statusConfig = {
    'accepted': { text: 'å¾…æœåŠ¡', desc: 'è¯·æŒ‰æ—¶åˆ°è¾¾æœåŠ¡åœ°ç‚¹', steps: ['completed'] },
    'departed': { text: 'å‰å¾€ä¸­', desc: 'æ­£åœ¨å‰å¾€å®¢æˆ·ä½ç½®', steps: ['completed', 'completed'] },
    'arrived': { text: 'å·²åˆ°è¾¾', desc: 'è¯·è”ç³»å®¢æˆ·ç¡®è®¤å¼€å§‹æœåŠ¡', steps: ['completed', 'completed', 'completed'] },
    'in_progress': { text: 'æœåŠ¡ä¸­', desc: 'æœåŠ¡è¿›è¡Œä¸­ï¼Œè¯·ä¸“æ³¨æœåŠ¡', steps: ['completed', 'completed', 'completed', 'active'] },
    'completed': { text: 'å·²å®Œæˆ', desc: 'æœåŠ¡å·²å®Œæˆ', steps: ['completed', 'completed', 'completed', 'completed', 'completed'] }
  };

  let timerInterval = null;
  let serviceStartTime = null;

  // åˆå§‹åŒ–
  function init() {
    const params = TECH.getParams();
    if (params.action === 'depart') {
      orderData.status = 'departed';
    }
    
    renderOrderDetail();
    updateProgress();
    updateActions();
  }

  // æ¸²æŸ“è®¢å•è¯¦æƒ…
  function renderOrderDetail() {
    document.getElementById('customerName').textContent = orderData.customerName;
    document.getElementById('customerPhone').textContent = orderData.phone;
    document.getElementById('customerAddress').textContent = orderData.address;
    document.getElementById('serviceName').textContent = `${orderData.service} ${orderData.duration}åˆ†é’Ÿ`;
    document.getElementById('serviceTime').textContent = orderData.time;
    document.getElementById('serviceDuration').textContent = `${orderData.duration}åˆ†é’Ÿ`;
    document.getElementById('servicePrice').textContent = orderData.price;
    
    const expectedIncome = orderData.price * (1 - orderData.commission);
    document.getElementById('expectedIncome').textContent = `Â¥${expectedIncome.toFixed(2)}`;
    
    document.getElementById('orderRemark').textContent = orderData.remark || 'æ— å¤‡æ³¨';
  }

  // æ›´æ–°è¿›åº¦æ¡
  function updateProgress() {
    const config = statusConfig[orderData.status];
    if (!config) return;

    document.getElementById('statusText').textContent = config.text;
    document.getElementById('statusDesc').textContent = config.desc;

    const stepIds = ['step-depart', 'step-arrive', 'step-start', 'step-complete'];
    const lines = document.querySelectorAll('.progress-line');
    
    stepIds.forEach((id, index) => {
      const step = document.getElementById(id);
      const stepState = config.steps[index + 1];
      
      step.classList.remove('completed', 'active');
      if (stepState) {
        step.classList.add(stepState);
      }
      
      // æ›´æ–°è¿æ¥çº¿
      if (index < lines.length && config.steps[index + 1]) {
        lines[index].classList.add('completed');
      }
    });

    // æ˜¾ç¤º/éšè—è®¡æ—¶å™¨
    const timerCard = document.getElementById('timerCard');
    if (orderData.status === 'in_progress') {
      timerCard.style.display = 'block';
      startTimer();
    } else {
      timerCard.style.display = 'none';
      stopTimer();
    }
  }

  // æ›´æ–°æ“ä½œæŒ‰é’®
  function updateActions() {
    const container = document.getElementById('bottomActions');
    let html = '';

    switch (orderData.status) {
      case 'accepted':
        html = `
          <button class="btn btn-secondary" onclick="callCustomer()">è”ç³»å®¢æˆ·</button>
          <button class="btn btn-primary" onclick="handleDepart()">å‡ºå‘</button>
        `;
        break;
      case 'departed':
        html = `
          <button class="btn btn-secondary" onclick="openNavigation()">æ‰“å¼€å¯¼èˆª</button>
          <button class="btn btn-primary" onclick="handleArrive()">å·²åˆ°è¾¾</button>
        `;
        break;
      case 'arrived':
        html = `
          <button class="btn btn-secondary" onclick="callCustomer()">è”ç³»å®¢æˆ·</button>
          <button class="btn btn-success" onclick="handleStartService()">å¼€å§‹æœåŠ¡</button>
        `;
        break;
      case 'in_progress':
        html = `
          <button class="btn btn-success btn-block" onclick="handleComplete()">å®ŒæˆæœåŠ¡</button>
        `;
        break;
      case 'completed':
        html = `
          <button class="btn btn-primary btn-block" onclick="TECH.navigateTo('order/list')">è¿”å›è®¢å•åˆ—è¡¨</button>
        `;
        break;
    }

    container.innerHTML = html;
  }

  // å‡ºå‘
  window.handleDepart = function() {
    orderData.status = 'departed';
    TECH.showToast('å·²å¼€å§‹å‡ºå‘ï¼Œè¯·æ³¨æ„å®‰å…¨');
    updateProgress();
    updateActions();
  };

  // åˆ°è¾¾
  window.handleArrive = function() {
    orderData.status = 'arrived';
    TECH.showToast('å·²æ ‡è®°åˆ°è¾¾ï¼Œè¯·è”ç³»å®¢æˆ·');
    updateProgress();
    updateActions();
  };

  // å¼€å§‹æœåŠ¡
  window.handleStartService = function() {
    orderData.status = 'in_progress';
    serviceStartTime = new Date();
    orderData.serviceStartTime = serviceStartTime;
    
    document.getElementById('startTime').textContent = TECH.formatTime(serviceStartTime);
    const endTime = new Date(serviceStartTime.getTime() + orderData.duration * 60 * 1000);
    document.getElementById('endTime').textContent = TECH.formatTime(endTime);
    
    TECH.showToast('æœåŠ¡å·²å¼€å§‹ï¼Œè®¡æ—¶ä¸­');
    updateProgress();
    updateActions();
  };

  // å®ŒæˆæœåŠ¡
  window.handleComplete = async function() {
    const confirmed = await TECH.showConfirm('ç¡®è®¤å·²å®ŒæˆæœåŠ¡ï¼Ÿ');
    if (confirmed) {
      orderData.status = 'completed';
      stopTimer();
      TECH.showToast('æœåŠ¡å·²å®Œæˆï¼Œæ”¶å…¥å·²è®¡å…¥é’±åŒ…');
      updateProgress();
      updateActions();
    }
  };

  // è”ç³»å®¢æˆ·
  window.callCustomer = function() {
    TECH.showToast('æ­£åœ¨æ‹¨æ‰“å®¢æˆ·ç”µè¯...');
  };

  // æ‰“å¼€å¯¼èˆª
  window.openNavigation = function() {
    TECH.showToast('æ­£åœ¨æ‰“å¼€å¯¼èˆª...');
    // å®é™…åº”è°ƒç”¨åœ°å›¾å¯¼èˆª
  };

  // å¼€å§‹è®¡æ—¶
  function startTimer() {
    if (timerInterval) return;
    
    if (!serviceStartTime) {
      serviceStartTime = new Date();
    }
    
    timerInterval = setInterval(() => {
      const now = new Date();
      const diff = Math.floor((now - serviceStartTime) / 1000);
      
      const hours = Math.floor(diff / 3600);
      const minutes = Math.floor((diff % 3600) / 60);
      const seconds = diff % 60;
      
      document.getElementById('timerValue').textContent = 
        `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }, 1000);
  }

  // åœæ­¢è®¡æ—¶
  function stopTimer() {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
  }

  init();
})();
</script>
