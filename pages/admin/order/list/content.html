<div class="page-order-list">
  <!-- 统计卡片 -->
  <div class="stat-cards" style="grid-template-columns: repeat(5, 1fr);">
    <div class="stat-card">
      <div class="stat-card-title">今日订单</div>
      <div class="stat-card-value">68</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-title">待接单</div>
      <div class="stat-card-value" style="color:var(--warning-color)">12</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-title">进行中</div>
      <div class="stat-card-value" style="color:var(--primary-color)">8</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-title">已完成</div>
      <div class="stat-card-value" style="color:var(--success-color)">45</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-title">待退款</div>
      <div class="stat-card-value" style="color:var(--error-color)">3</div>
    </div>
  </div>

  <!-- 筛选栏 -->
  <div class="card">
    <div class="filter-bar">
      <input type="text" class="filter-input" placeholder="订单号/用户/技师" id="searchInput">
      <select class="filter-select" id="statusFilter">
        <option value="">全部状态</option>
        <option value="0">待支付</option>
        <option value="1">待接单</option>
        <option value="2">待服务</option>
        <option value="3">出发中</option>
        <option value="4">服务中</option>
        <option value="5">已完成</option>
        <option value="6">已取消</option>
        <option value="7">已退款</option>
      </select>
      <input type="date" class="filter-input" id="dateFrom" style="min-width:140px">
      <span style="color:var(--text-secondary)">至</span>
      <input type="date" class="filter-input" id="dateTo" style="min-width:140px">
      <button class="btn btn-primary" onclick="searchOrders()">搜索</button>
      <button class="btn btn-default" onclick="resetFilters()">重置</button>
    </div>
  </div>

  <!-- 订单列表 -->
  <div class="card">
    <div class="card-title">订单列表</div>
    <table class="data-table">
      <thead>
        <tr>
          <th>订单号</th>
          <th>用户</th>
          <th>技师</th>
          <th>服务项目</th>
          <th>预约时间</th>
          <th>金额</th>
          <th>状态</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="orderTableBody">
        <!-- 动态生成 -->
      </tbody>
    </table>
    
    <div class="pagination" id="pagination">
      <!-- 动态生成 -->
    </div>
  </div>
</div>

<!-- 订单详情弹窗 -->
<div class="modal-overlay" id="orderDetailModal" style="display:none">
  <div class="modal" style="min-width:700px;max-height:90vh">
    <div class="modal-header">
      <span class="modal-title">订单详情</span>
      <span class="modal-close" onclick="closeOrderDetail()">×</span>
    </div>
    <div class="modal-body" id="orderDetailContent" style="max-height:calc(90vh - 130px);overflow-y:auto">
      <!-- 动态生成 -->
    </div>
    <div class="modal-footer">
      <button class="btn btn-default" onclick="closeOrderDetail()">关闭</button>
    </div>
  </div>
</div>

<!-- 退款弹窗 -->
<div class="modal-overlay" id="refundModal" style="display:none">
  <div class="modal" style="min-width:450px">
    <div class="modal-header">
      <span class="modal-title">退款处理</span>
      <span class="modal-close" onclick="closeRefundModal()">×</span>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">订单号</label>
        <input type="text" class="form-control" id="refundOrderNo" readonly>
      </div>
      <div class="form-group">
        <label class="form-label">订单金额</label>
        <input type="text" class="form-control" id="refundOrderAmount" readonly>
      </div>
      <div class="form-group">
        <label class="form-label required">退款金额</label>
        <input type="number" class="form-control" id="refundAmount" min="0" step="0.01">
      </div>
      <div class="form-group">
        <label class="form-label required">退款原因</label>
        <textarea class="form-control" id="refundReason" rows="3" placeholder="请输入退款原因"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-default" onclick="closeRefundModal()">取消</button>
      <button class="btn btn-danger" onclick="confirmRefund()">确认退款</button>
    </div>
  </div>
</div>

<style>
.action-btns {
  display: flex;
  gap: 8px;
}

.action-btn {
  padding: 4px 8px;
  font-size: 12px;
  border-radius: 4px;
  cursor: pointer;
  border: none;
  background: var(--bg-color);
  color: var(--text-primary);
}

.action-btn:hover {
  background: var(--primary-light);
  color: var(--primary-color);
}

.action-btn.danger:hover {
  background: #fde8ea;
  color: var(--error-color);
}

.detail-section {
  margin-bottom: 20px;
}

.detail-section-title {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border-color);
}

.detail-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

.detail-item {
  display: flex;
}

.detail-label {
  width: 80px;
  color: var(--text-secondary);
  flex-shrink: 0;
}

.detail-value {
  flex: 1;
  color: var(--text-primary);
}

.timeline {
  padding-left: 20px;
  border-left: 2px solid var(--border-color);
}

.timeline-item {
  position: relative;
  padding-bottom: 16px;
  padding-left: 20px;
}

.timeline-item::before {
  content: '';
  position: absolute;
  left: -26px;
  top: 4px;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--border-color);
}

.timeline-item.active::before {
  background: var(--primary-color);
}

.timeline-time {
  font-size: 12px;
  color: var(--text-placeholder);
}

.timeline-text {
  font-size: 14px;
  color: var(--text-primary);
  margin-top: 4px;
}
</style>

<script>
(function() {
  // 模拟订单数据
  const mockOrders = [
    { id: 1, no: 'QY20260111001', user: '小明', tech: '李师傅', service: '中式推拿60分钟', time: '2026-01-11 14:00', amount: 298, status: 5 },
    { id: 2, no: 'QY20260111002', user: '小红', tech: '王师傅', service: '肩颈舒缓45分钟', time: '2026-01-11 15:30', amount: 198, status: 4 },
    { id: 3, no: 'QY20260111003', user: '张三', tech: '张师傅', service: '足底按摩90分钟', time: '2026-01-11 16:00', amount: 358, status: 3 },
    { id: 4, no: 'QY20260111004', user: '李四', tech: '刘师傅', service: '全身精油SPA', time: '2026-01-11 17:00', amount: 598, status: 2 },
    { id: 5, no: 'QY20260111005', user: '王五', tech: '陈师傅', service: '泰式按摩60分钟', time: '2026-01-11 18:00', amount: 328, status: 1 },
    { id: 6, no: 'QY20260111006', user: '赵六', tech: '-', service: '中式推拿90分钟', time: '2026-01-11 19:00', amount: 398, status: 0 },
    { id: 7, no: 'QY20260110001', user: '钱七', tech: '李师傅', service: '肩颈舒缓45分钟', time: '2026-01-10 14:00', amount: 198, status: 5 },
    { id: 8, no: 'QY20260110002', user: '孙八', tech: '王师傅', service: '足底按摩60分钟', time: '2026-01-10 15:00', amount: 258, status: 6 },
    { id: 9, no: 'QY20260110003', user: '周九', tech: '张师傅', service: '全身精油SPA', time: '2026-01-10 16:00', amount: 598, status: 7 },
    { id: 10, no: 'QY20260109001', user: '吴十', tech: '刘师傅', service: '中式推拿60分钟', time: '2026-01-09 14:00', amount: 298, status: 5 }
  ];

  const statusMap = {
    0: { text: '待支付', class: 'warning' },
    1: { text: '待接单', class: 'info' },
    2: { text: '待服务', class: 'info' },
    3: { text: '出发中', class: 'info' },
    4: { text: '服务中', class: 'info' },
    5: { text: '已完成', class: 'success' },
    6: { text: '已取消', class: 'error' },
    7: { text: '已退款', class: 'error' }
  };

  let currentPage = 1;
  const pageSize = 10;
  let filteredOrders = [...mockOrders];
  let currentOrderId = null;

  function init() {
    renderTable();
    renderPagination();
  }

  function renderTable() {
    const tbody = document.getElementById('orderTableBody');
    const start = (currentPage - 1) * pageSize;
    const pageOrders = filteredOrders.slice(start, start + pageSize);

    tbody.innerHTML = pageOrders.map(order => {
      const status = statusMap[order.status];
      const canRefund = [1, 2, 3, 4, 5].includes(order.status);
      
      return `
        <tr>
          <td>${order.no}</td>
          <td>${order.user}</td>
          <td>${order.tech}</td>
          <td>${order.service}</td>
          <td>${order.time}</td>
          <td>¥${order.amount}</td>
          <td><span class="status-tag ${status.class}">${status.text}</span></td>
          <td>
            <div class="action-btns">
              <button class="action-btn" onclick="viewOrderDetail(${order.id})">详情</button>
              ${canRefund ? `<button class="action-btn danger" onclick="showRefund(${order.id})">退款</button>` : ''}
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  function renderPagination() {
    const totalPages = Math.ceil(filteredOrders.length / pageSize);
    const pagination = document.getElementById('pagination');
    
    let html = `
      <button class="pagination-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>上一页</button>
    `;
    
    for (let i = 1; i <= Math.min(totalPages, 5); i++) {
      html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
    }
    
    html += `
      <button class="pagination-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>下一页</button>
    `;
    
    pagination.innerHTML = html;
  }

  window.goToPage = function(page) {
    const totalPages = Math.ceil(filteredOrders.length / pageSize);
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    renderTable();
    renderPagination();
  };

  window.searchOrders = function() {
    const keyword = document.getElementById('searchInput').value.toLowerCase();
    const status = document.getElementById('statusFilter').value;
    
    filteredOrders = mockOrders.filter(order => {
      const matchKeyword = !keyword || 
        order.no.toLowerCase().includes(keyword) ||
        order.user.toLowerCase().includes(keyword) ||
        order.tech.toLowerCase().includes(keyword);
      const matchStatus = !status || order.status.toString() === status;
      return matchKeyword && matchStatus;
    });
    
    currentPage = 1;
    renderTable();
    renderPagination();
  };

  window.resetFilters = function() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    filteredOrders = [...mockOrders];
    currentPage = 1;
    renderTable();
    renderPagination();
  };

  window.viewOrderDetail = function(orderId) {
    const order = mockOrders.find(o => o.id === orderId);
    if (!order) return;

    const status = statusMap[order.status];

    const content = `
      <div class="detail-section">
        <div class="detail-section-title">订单信息</div>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">订单号</span>
            <span class="detail-value">${order.no}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">订单状态</span>
            <span class="detail-value">
              <span class="status-tag ${status.class}">${status.text}</span>
            </span>
          </div>
          <div class="detail-item">
            <span class="detail-label">服务项目</span>
            <span class="detail-value">${order.service}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">订单金额</span>
            <span class="detail-value">¥${order.amount}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">预约时间</span>
            <span class="detail-value">${order.time}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">支付方式</span>
            <span class="detail-value">微信支付</span>
          </div>
        </div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">用户信息</div>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">用户昵称</span>
            <span class="detail-value">${order.user}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">联系电话</span>
            <span class="detail-value">138****1234</span>
          </div>
          <div class="detail-item" style="grid-column: span 2">
            <span class="detail-label">服务地址</span>
            <span class="detail-value">北京市朝阳区xxx小区x号楼x单元xxx室</span>
          </div>
        </div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">技师信息</div>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">技师姓名</span>
            <span class="detail-value">${order.tech}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">联系电话</span>
            <span class="detail-value">139****5678</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">所属商家</span>
            <span class="detail-value">轻松养生馆</span>
          </div>
        </div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">订单时间线</div>
        <div class="timeline">
          <div class="timeline-item active">
            <div class="timeline-time">2026-01-11 10:30</div>
            <div class="timeline-text">用户下单</div>
          </div>
          <div class="timeline-item active">
            <div class="timeline-time">2026-01-11 10:31</div>
            <div class="timeline-text">支付成功</div>
          </div>
          ${order.status >= 2 ? `
          <div class="timeline-item active">
            <div class="timeline-time">2026-01-11 10:35</div>
            <div class="timeline-text">技师接单</div>
          </div>
          ` : ''}
          ${order.status >= 3 ? `
          <div class="timeline-item active">
            <div class="timeline-time">2026-01-11 13:30</div>
            <div class="timeline-text">技师出发</div>
          </div>
          ` : ''}
          ${order.status >= 4 ? `
          <div class="timeline-item active">
            <div class="timeline-time">2026-01-11 13:55</div>
            <div class="timeline-text">开始服务</div>
          </div>
          ` : ''}
          ${order.status === 5 ? `
          <div class="timeline-item active">
            <div class="timeline-time">2026-01-11 14:55</div>
            <div class="timeline-text">服务完成</div>
          </div>
          ` : ''}
        </div>
      </div>
    `;

    document.getElementById('orderDetailContent').innerHTML = content;
    document.getElementById('orderDetailModal').style.display = 'flex';
  };

  window.closeOrderDetail = function() {
    document.getElementById('orderDetailModal').style.display = 'none';
  };

  window.showRefund = function(orderId) {
    const order = mockOrders.find(o => o.id === orderId);
    if (!order) return;

    currentOrderId = orderId;
    document.getElementById('refundOrderNo').value = order.no;
    document.getElementById('refundOrderAmount').value = '¥' + order.amount;
    document.getElementById('refundAmount').value = order.amount;
    document.getElementById('refundReason').value = '';
    document.getElementById('refundModal').style.display = 'flex';
  };

  window.closeRefundModal = function() {
    document.getElementById('refundModal').style.display = 'none';
    currentOrderId = null;
  };

  window.confirmRefund = async function() {
    const amount = parseFloat(document.getElementById('refundAmount').value);
    const reason = document.getElementById('refundReason').value.trim();
    const order = mockOrders.find(o => o.id === currentOrderId);

    if (!order) return;

    if (isNaN(amount) || amount <= 0 || amount > order.amount) {
      ADMIN.showToast('请输入有效的退款金额');
      return;
    }

    if (!reason) {
      ADMIN.showToast('请输入退款原因');
      return;
    }

    const confirmed = await ADMIN.showConfirm(`确定要退款 ¥${amount} 吗？`);
    if (confirmed) {
      order.status = 7;
      renderTable();
      closeRefundModal();
      ADMIN.showToast('退款成功');
    }
  };

  init();
})();
</script>
