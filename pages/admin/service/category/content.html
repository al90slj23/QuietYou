<div class="page-service-category">
  <!-- æ“ä½œæ  -->
  <div class="card">
    <div class="filter-bar">
      <button class="btn btn-primary" onclick="showAddCategory()">+ æ·»åŠ åˆ†ç±»</button>
      <button class="btn btn-default" onclick="ADMIN.navigateTo('service/item')">ç®¡ç†æœåŠ¡é¡¹ç›®</button>
    </div>
  </div>

  <!-- åˆ†ç±»åˆ—è¡¨ -->
  <div class="card">
    <div class="card-title">æœåŠ¡åˆ†ç±»</div>
    <table class="data-table">
      <thead>
        <tr>
          <th>æ’åº</th>
          <th>å›¾æ ‡</th>
          <th>åˆ†ç±»åç§°</th>
          <th>æè¿°</th>
          <th>æœåŠ¡é¡¹ç›®æ•°</th>
          <th>çŠ¶æ€</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="categoryTableBody">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </tbody>
    </table>
  </div>
</div>

<!-- æ·»åŠ /ç¼–è¾‘åˆ†ç±»å¼¹çª— -->
<div class="modal-overlay" id="categoryModal" style="display:none">
  <div class="modal" style="min-width:500px">
    <div class="modal-header">
      <span class="modal-title" id="categoryModalTitle">æ·»åŠ åˆ†ç±»</span>
      <span class="modal-close" onclick="closeCategoryModal()">Ã—</span>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label required">åˆ†ç±»åç§°</label>
        <input type="text" class="form-control" id="categoryName" placeholder="è¯·è¾“å…¥åˆ†ç±»åç§°">
      </div>
      <div class="form-group">
        <label class="form-label required">å›¾æ ‡</label>
        <div class="icon-picker" id="iconPicker">
          <span class="icon-option selected" data-icon="ğŸ’†">ğŸ’†</span>
          <span class="icon-option" data-icon="ğŸ§˜">ğŸ§˜</span>
          <span class="icon-option" data-icon="ğŸ¦¶">ğŸ¦¶</span>
          <span class="icon-option" data-icon="ğŸ’ª">ğŸ’ª</span>
          <span class="icon-option" data-icon="ğŸŒ¿">ğŸŒ¿</span>
          <span class="icon-option" data-icon="ğŸ”¥">ğŸ”¥</span>
          <span class="icon-option" data-icon="ğŸ’">ğŸ’</span>
          <span class="icon-option" data-icon="ğŸŒ¸">ğŸŒ¸</span>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">æè¿°</label>
        <textarea class="form-control" id="categoryDesc" rows="3" placeholder="è¯·è¾“å…¥åˆ†ç±»æè¿°"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">æ’åº</label>
        <input type="number" class="form-control" id="categorySort" value="0" min="0">
        <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">æ•°å­—è¶Šå°è¶Šé å‰</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-default" onclick="closeCategoryModal()">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="saveCategory()">ä¿å­˜</button>
    </div>
  </div>
</div>

<style>
.icon-picker {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.icon-option {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.icon-option:hover {
  border-color: var(--primary-color);
}

.icon-option.selected {
  border-color: var(--primary-color);
  background: var(--primary-light);
}

.category-icon {
  font-size: 24px;
}

.action-btns {
  display: flex;
  gap: 8px;
}

.action-btn {
  padding: 4px 8px;
  font-size: 12px;
  border-radius: 4px;
  cursor: pointer;
  border: none;
  background: var(--bg-color);
  color: var(--text-primary);
}

.action-btn:hover {
  background: var(--primary-light);
  color: var(--primary-color);
}

.action-btn.danger:hover {
  background: #fde8ea;
  color: var(--error-color);
}

.sort-btns {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.sort-btn {
  padding: 2px 6px;
  font-size: 10px;
  border: none;
  background: var(--bg-color);
  border-radius: 2px;
  cursor: pointer;
}

.sort-btn:hover {
  background: var(--primary-light);
}
</style>

<script>
(function() {
  // æ¨¡æ‹Ÿåˆ†ç±»æ•°æ®
  let categories = [
    { id: 1, icon: 'ğŸ’†', name: 'ä¸­å¼æ¨æ‹¿', desc: 'ä¼ ç»Ÿä¸­åŒ»æ¨æ‹¿æ‰‹æ³•ï¼Œç–é€šç»ç»œ', items: 8, sort: 1, status: 1 },
    { id: 2, icon: 'ğŸ§˜', name: 'æ³°å¼æŒ‰æ‘©', desc: 'æ­£å®—æ³°å¼æŒ‰æ‘©ï¼Œèˆ’å±•ç­‹éª¨', items: 5, sort: 2, status: 1 },
    { id: 3, icon: 'ğŸ¦¶', name: 'è¶³ç–—ä¿å¥', desc: 'è¶³åº•ç©´ä½æŒ‰æ‘©ï¼Œä¿ƒè¿›è¡€æ¶²å¾ªç¯', items: 6, sort: 3, status: 1 },
    { id: 4, icon: 'ğŸŒ¿', name: 'ç²¾æ²¹SPA', desc: 'èŠ³é¦™ç²¾æ²¹æŠ¤ç†ï¼Œæ”¾æ¾èº«å¿ƒ', items: 4, sort: 4, status: 1 },
    { id: 5, icon: 'ğŸ”¥', name: 'è‰¾ç¸ç†ç–—', desc: 'ä¼ ç»Ÿè‰¾ç¸ç–—æ³•ï¼Œæ¸©ç»æ•£å¯’', items: 3, sort: 5, status: 1 },
    { id: 6, icon: 'ğŸ’', name: 'åˆ®ç—§æ‹”ç½', desc: 'ä¸­åŒ»åˆ®ç—§æ‹”ç½ï¼Œç¥›æ¹¿æ’æ¯’', items: 4, sort: 6, status: 0 }
  ];

  let editingId = null;
  let selectedIcon = 'ğŸ’†';

  function init() {
    renderTable();
    initIconPicker();
  }

  function renderTable() {
    const tbody = document.getElementById('categoryTableBody');
    
    // æŒ‰æ’åºæ’åˆ—
    const sorted = [...categories].sort((a, b) => a.sort - b.sort);

    tbody.innerHTML = sorted.map((cat, index) => `
      <tr>
        <td>
          <div class="sort-btns">
            <button class="sort-btn" onclick="moveUp(${cat.id})" ${index === 0 ? 'disabled' : ''}>â–²</button>
            <button class="sort-btn" onclick="moveDown(${cat.id})" ${index === sorted.length - 1 ? 'disabled' : ''}>â–¼</button>
          </div>
        </td>
        <td><span class="category-icon">${cat.icon}</span></td>
        <td>${cat.name}</td>
        <td>${cat.desc}</td>
        <td>${cat.items}</td>
        <td>
          <span class="status-tag ${cat.status === 1 ? 'success' : 'error'}">
            ${cat.status === 1 ? 'å¯ç”¨' : 'ç¦ç”¨'}
          </span>
        </td>
        <td>
          <div class="action-btns">
            <button class="action-btn" onclick="editCategory(${cat.id})">ç¼–è¾‘</button>
            <button class="action-btn" onclick="toggleStatus(${cat.id})">
              ${cat.status === 1 ? 'ç¦ç”¨' : 'å¯ç”¨'}
            </button>
            <button class="action-btn danger" onclick="deleteCategory(${cat.id})">åˆ é™¤</button>
          </div>
        </td>
      </tr>
    `).join('');
  }

  function initIconPicker() {
    const picker = document.getElementById('iconPicker');
    picker.addEventListener('click', (e) => {
      if (e.target.classList.contains('icon-option')) {
        picker.querySelectorAll('.icon-option').forEach(opt => opt.classList.remove('selected'));
        e.target.classList.add('selected');
        selectedIcon = e.target.dataset.icon;
      }
    });
  }

  window.showAddCategory = function() {
    editingId = null;
    document.getElementById('categoryModalTitle').textContent = 'æ·»åŠ åˆ†ç±»';
    document.getElementById('categoryName').value = '';
    document.getElementById('categoryDesc').value = '';
    document.getElementById('categorySort').value = categories.length + 1;
    
    // é‡ç½®å›¾æ ‡é€‰æ‹©
    const picker = document.getElementById('iconPicker');
    picker.querySelectorAll('.icon-option').forEach(opt => opt.classList.remove('selected'));
    picker.querySelector('[data-icon="ğŸ’†"]').classList.add('selected');
    selectedIcon = 'ğŸ’†';
    
    document.getElementById('categoryModal').style.display = 'flex';
  };

  window.editCategory = function(id) {
    const cat = categories.find(c => c.id === id);
    if (!cat) return;

    editingId = id;
    document.getElementById('categoryModalTitle').textContent = 'ç¼–è¾‘åˆ†ç±»';
    document.getElementById('categoryName').value = cat.name;
    document.getElementById('categoryDesc').value = cat.desc;
    document.getElementById('categorySort').value = cat.sort;
    
    // è®¾ç½®å›¾æ ‡é€‰æ‹©
    const picker = document.getElementById('iconPicker');
    picker.querySelectorAll('.icon-option').forEach(opt => {
      opt.classList.toggle('selected', opt.dataset.icon === cat.icon);
    });
    selectedIcon = cat.icon;
    
    document.getElementById('categoryModal').style.display = 'flex';
  };

  window.closeCategoryModal = function() {
    document.getElementById('categoryModal').style.display = 'none';
    editingId = null;
  };

  window.saveCategory = function() {
    const name = document.getElementById('categoryName').value.trim();
    const desc = document.getElementById('categoryDesc').value.trim();
    const sort = parseInt(document.getElementById('categorySort').value) || 0;

    if (!name) {
      ADMIN.showToast('è¯·è¾“å…¥åˆ†ç±»åç§°');
      return;
    }

    if (editingId) {
      // ç¼–è¾‘
      const cat = categories.find(c => c.id === editingId);
      if (cat) {
        cat.name = name;
        cat.icon = selectedIcon;
        cat.desc = desc;
        cat.sort = sort;
      }
      ADMIN.showToast('åˆ†ç±»å·²æ›´æ–°');
    } else {
      // æ·»åŠ 
      const newId = Math.max(...categories.map(c => c.id)) + 1;
      categories.push({
        id: newId,
        icon: selectedIcon,
        name,
        desc,
        items: 0,
        sort,
        status: 1
      });
      ADMIN.showToast('åˆ†ç±»å·²æ·»åŠ ');
    }

    renderTable();
    closeCategoryModal();
  };

  window.toggleStatus = function(id) {
    const cat = categories.find(c => c.id === id);
    if (cat) {
      cat.status = cat.status === 1 ? 0 : 1;
      renderTable();
      ADMIN.showToast(cat.status === 1 ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨');
    }
  };

  window.deleteCategory = async function(id) {
    const cat = categories.find(c => c.id === id);
    if (!cat) return;

    if (cat.items > 0) {
      ADMIN.showToast('è¯¥åˆ†ç±»ä¸‹æœ‰æœåŠ¡é¡¹ç›®ï¼Œæ— æ³•åˆ é™¤');
      return;
    }

    const confirmed = await ADMIN.showConfirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç±» ${cat.name} å—ï¼Ÿ`);
    if (confirmed) {
      categories = categories.filter(c => c.id !== id);
      renderTable();
      ADMIN.showToast('åˆ†ç±»å·²åˆ é™¤');
    }
  };

  window.moveUp = function(id) {
    const sorted = [...categories].sort((a, b) => a.sort - b.sort);
    const index = sorted.findIndex(c => c.id === id);
    if (index > 0) {
      const temp = sorted[index].sort;
      sorted[index].sort = sorted[index - 1].sort;
      sorted[index - 1].sort = temp;
      renderTable();
    }
  };

  window.moveDown = function(id) {
    const sorted = [...categories].sort((a, b) => a.sort - b.sort);
    const index = sorted.findIndex(c => c.id === id);
    if (index < sorted.length - 1) {
      const temp = sorted[index].sort;
      sorted[index].sort = sorted[index + 1].sort;
      sorted[index + 1].sort = temp;
      renderTable();
    }
  };

  init();
})();
</script>
