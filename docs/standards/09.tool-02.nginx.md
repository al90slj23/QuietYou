# Nginx 配置规范

## 概述

本项目使用宝塔面板管理 Nginx，配置文件分布在多个位置。Vue SPA 应用需要正确配置才能支持前端路由。

## 配置文件位置（宝塔面板）

```
/www/server/panel/vhost/nginx/qy.im.sh.cn.conf      # 主配置
/www/server/panel/vhost/rewrite/qy.im.sh.cn.conf    # 伪静态配置（推荐修改这里）
/www/server/panel/vhost/nginx/extension/qy.im.sh.cn/*.conf  # 扩展配置（慎用）
```

**加载顺序**：主配置 → extension/*.conf → 伪静态配置

## 当前生产配置

### 主配置关键设置

```nginx
# root 指向构建产物目录
root /www/wwwroot/qy.im.sh.cn/pages;
```

### 伪静态配置（/www/server/panel/vhost/rewrite/qy.im.sh.cn.conf）

```nginx
# ================================================================
# 轻养到家 nginx 路由配置
# root 已改为 /www/wwwroot/qy.im.sh.cn/pages
# ================================================================

# API 请求走 PHP（使用 alias 指向项目根目录的 api/）
location /api/ {
    alias /www/wwwroot/qy.im.sh.cn/api/;
    index index.php;
    
    location ~ \.php$ {
        fastcgi_pass unix:/tmp/php-cgi-82.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $request_filename;
        include fastcgi_params;
    }
}

# 白皮书静态文件（使用 alias 指向 public/whitepaper/）
location /whitepaper/ {
    alias /www/wwwroot/qy.im.sh.cn/public/whitepaper/;
}

# SPA 前端路由 - 所有其他请求回退到 index.html
location / {
    try_files $uri $uri/ /index.html;
}
```

## SPA 路由原理

Vue Router 使用 `createWebHistory()` 模式，URL 如 `/user/home` 实际上不存在对应的物理文件。

Nginx 的 `try_files $uri $uri/ /index.html` 规则：
1. 先尝试找 `$uri` 对应的文件（如 `/assets/xxx.js`）
2. 再尝试找 `$uri/` 目录
3. 都找不到则返回 `/index.html`，由 Vue Router 处理路由

## 常见问题

### 问题：子路由返回 403/404/500

**症状**：`/user/`、`/tech/`、`/admin/` 返回错误，但 `/` 正常

**排查步骤**：

1. 检查错误日志
   ```bash
   tail -20 /www/wwwlogs/qy.im.sh.cn.error.log
   ```

2. 检查是否有冲突的 location 配置
   ```bash
   ls -la /www/server/panel/vhost/nginx/extension/qy.im.sh.cn/
   cat /www/server/panel/vhost/rewrite/qy.im.sh.cn.conf
   ```

3. 检查 `pages/` 目录下是否有残留的子目录
   ```bash
   ls -la /www/wwwroot/qy.im.sh.cn/pages/
   ```

**常见原因**：

| 错误 | 原因 | 解决方案 |
|------|------|---------|
| 403 Forbidden | 存在物理目录但无 index.html | 删除残留目录 |
| 500 Internal Error | rewrite 循环重定向 | 检查 extension/*.conf 是否有冲突配置 |
| 404 Not Found | try_files 配置错误 | 确保 fallback 到 /index.html |

### 问题：rewrite or internal redirection cycle

**原因**：多个 location 配置冲突，导致无限重定向

**解决方案**：
1. 删除 `extension/qy.im.sh.cn/` 下的冲突配置文件
2. 只保留伪静态配置中的 `try_files`

### 问题：API 请求 404

**原因**：主配置 `root` 改为 `pages/` 后，`/api/` 路径找不到

**解决方案**：在伪静态配置中使用 `alias` 指向正确的 API 目录

## 修改配置后

```bash
# 测试配置语法
nginx -t

# 重载配置
nginx -s reload
```

## 禁止事项

1. ❌ 不要在 `extension/*.conf` 中添加 SPA 路由配置
2. ❌ 不要为每个前端路由创建单独的 location
3. ❌ 不要在 `pages/` 目录下手动创建子目录
4. ❌ 不要使用 `rewrite` 规则处理 SPA 路由，用 `try_files`
